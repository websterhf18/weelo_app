9065d086cd4487b11cf131f2b8f45846
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.createSelectorHook = createSelectorHook;
exports.useSelector = void 0;

var _react = require("react");

var _useReduxContext2 = require("./useReduxContext");

var _Subscription = _interopRequireDefault(require("../utils/Subscription"));

var _useIsomorphicLayoutEffect = require("../utils/useIsomorphicLayoutEffect");

var _Context = require("../components/Context");

var refEquality = function refEquality(a, b) {
  return a === b;
};

function useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub) {
  var _useReducer = (0, _react.useReducer)(function (s) {
    return s + 1;
  }, 0),
      forceRender = _useReducer[1];

  var subscription = (0, _react.useMemo)(function () {
    return new _Subscription["default"](store, contextSub);
  }, [store, contextSub]);
  var latestSubscriptionCallbackError = (0, _react.useRef)();
  var latestSelector = (0, _react.useRef)();
  var latestStoreState = (0, _react.useRef)();
  var latestSelectedState = (0, _react.useRef)();
  var storeState = store.getState();
  var selectedState;

  try {
    if (selector !== latestSelector.current || storeState !== latestStoreState.current || latestSubscriptionCallbackError.current) {
      var newSelectedState = selector(storeState);

      if (latestSelectedState.current === undefined || !equalityFn(newSelectedState, latestSelectedState.current)) {
        selectedState = newSelectedState;
      } else {
        selectedState = latestSelectedState.current;
      }
    } else {
      selectedState = latestSelectedState.current;
    }
  } catch (err) {
    if (latestSubscriptionCallbackError.current) {
      err.message += "\nThe error may be correlated with this previous error:\n" + latestSubscriptionCallbackError.current.stack + "\n\n";
    }

    throw err;
  }

  (0, _useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function () {
    latestSelector.current = selector;
    latestStoreState.current = storeState;
    latestSelectedState.current = selectedState;
    latestSubscriptionCallbackError.current = undefined;
  });
  (0, _useIsomorphicLayoutEffect.useIsomorphicLayoutEffect)(function () {
    function checkForUpdates() {
      try {
        var newStoreState = store.getState();

        var _newSelectedState = latestSelector.current(newStoreState);

        if (equalityFn(_newSelectedState, latestSelectedState.current)) {
          return;
        }

        latestSelectedState.current = _newSelectedState;
        latestStoreState.current = newStoreState;
      } catch (err) {
        latestSubscriptionCallbackError.current = err;
      }

      forceRender();
    }

    subscription.onStateChange = checkForUpdates;
    subscription.trySubscribe();
    checkForUpdates();
    return function () {
      return subscription.tryUnsubscribe();
    };
  }, [store, subscription]);
  return selectedState;
}

function createSelectorHook(context) {
  if (context === void 0) {
    context = _Context.ReactReduxContext;
  }

  var useReduxContext = context === _Context.ReactReduxContext ? _useReduxContext2.useReduxContext : function () {
    return (0, _react.useContext)(context);
  };
  return function useSelector(selector, equalityFn) {
    if (equalityFn === void 0) {
      equalityFn = refEquality;
    }

    if (process.env.NODE_ENV !== 'production') {
      if (!selector) {
        throw new Error("You must pass a selector to useSelector");
      }

      if (typeof selector !== 'function') {
        throw new Error("You must pass a function as a selector to useSelector");
      }

      if (typeof equalityFn !== 'function') {
        throw new Error("You must pass a function as an equality function to useSelector");
      }
    }

    var _useReduxContext = useReduxContext(),
        store = _useReduxContext.store,
        contextSub = _useReduxContext.subscription;

    var selectedState = useSelectorWithStoreAndSubscription(selector, equalityFn, store, contextSub);
    (0, _react.useDebugValue)(selectedState);
    return selectedState;
  };
}

var useSelector = createSelectorHook();
exports.useSelector = useSelector;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZVNlbGVjdG9yLmpzIl0sIm5hbWVzIjpbIl9pbnRlcm9wUmVxdWlyZURlZmF1bHQiLCJyZXF1aXJlIiwiZXhwb3J0cyIsIl9fZXNNb2R1bGUiLCJjcmVhdGVTZWxlY3Rvckhvb2siLCJ1c2VTZWxlY3RvciIsIl9yZWFjdCIsIl91c2VSZWR1eENvbnRleHQyIiwiX1N1YnNjcmlwdGlvbiIsIl91c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0IiwiX0NvbnRleHQiLCJyZWZFcXVhbGl0eSIsImEiLCJiIiwidXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24iLCJzZWxlY3RvciIsImVxdWFsaXR5Rm4iLCJzdG9yZSIsImNvbnRleHRTdWIiLCJfdXNlUmVkdWNlciIsInVzZVJlZHVjZXIiLCJzIiwiZm9yY2VSZW5kZXIiLCJzdWJzY3JpcHRpb24iLCJ1c2VNZW1vIiwibGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvciIsInVzZVJlZiIsImxhdGVzdFNlbGVjdG9yIiwibGF0ZXN0U3RvcmVTdGF0ZSIsImxhdGVzdFNlbGVjdGVkU3RhdGUiLCJzdG9yZVN0YXRlIiwiZ2V0U3RhdGUiLCJzZWxlY3RlZFN0YXRlIiwiY3VycmVudCIsIm5ld1NlbGVjdGVkU3RhdGUiLCJ1bmRlZmluZWQiLCJlcnIiLCJtZXNzYWdlIiwic3RhY2siLCJ1c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0IiwiY2hlY2tGb3JVcGRhdGVzIiwibmV3U3RvcmVTdGF0ZSIsIl9uZXdTZWxlY3RlZFN0YXRlIiwib25TdGF0ZUNoYW5nZSIsInRyeVN1YnNjcmliZSIsInRyeVVuc3Vic2NyaWJlIiwiY29udGV4dCIsIlJlYWN0UmVkdXhDb250ZXh0IiwidXNlUmVkdXhDb250ZXh0IiwidXNlQ29udGV4dCIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsIkVycm9yIiwiX3VzZVJlZHV4Q29udGV4dCIsInVzZURlYnVnVmFsdWUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlB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dUJDLEtBQXZCLEVBQThCQyxVQUE5QixDQUF2RDtBQUNBLEtBQUMsR0FBR1osTUFBTSxDQUFDaUQsYUFBWCxFQUEwQnZCLGFBQTFCO0FBQ0EsV0FBT0EsYUFBUDtBQUNELEdBMUJEO0FBMkJEOztBQTBCRCxJQUFJM0IsV0FBVyxHQUFnQkQsa0JBQWtCLEVBQWpEO0FBQ0FGLE9BQU8sQ0FBQ0csV0FBUixHQUFzQkEsV0FBdEIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxudmFyIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQgPSByZXF1aXJlKFwiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9pbnRlcm9wUmVxdWlyZURlZmF1bHRcIik7XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzLmNyZWF0ZVNlbGVjdG9ySG9vayA9IGNyZWF0ZVNlbGVjdG9ySG9vaztcbmV4cG9ydHMudXNlU2VsZWN0b3IgPSB2b2lkIDA7XG5cbnZhciBfcmVhY3QgPSByZXF1aXJlKFwicmVhY3RcIik7XG5cbnZhciBfdXNlUmVkdXhDb250ZXh0MiA9IHJlcXVpcmUoXCIuL3VzZVJlZHV4Q29udGV4dFwiKTtcblxudmFyIF9TdWJzY3JpcHRpb24gPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuLi91dGlscy9TdWJzY3JpcHRpb25cIikpO1xuXG52YXIgX3VzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QgPSByZXF1aXJlKFwiLi4vdXRpbHMvdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdFwiKTtcblxudmFyIF9Db250ZXh0ID0gcmVxdWlyZShcIi4uL2NvbXBvbmVudHMvQ29udGV4dFwiKTtcblxudmFyIHJlZkVxdWFsaXR5ID0gZnVuY3Rpb24gcmVmRXF1YWxpdHkoYSwgYikge1xuICByZXR1cm4gYSA9PT0gYjtcbn07XG5cbmZ1bmN0aW9uIHVzZVNlbGVjdG9yV2l0aFN0b3JlQW5kU3Vic2NyaXB0aW9uKHNlbGVjdG9yLCBlcXVhbGl0eUZuLCBzdG9yZSwgY29udGV4dFN1Yikge1xuICB2YXIgX3VzZVJlZHVjZXIgPSAoMCwgX3JlYWN0LnVzZVJlZHVjZXIpKGZ1bmN0aW9uIChzKSB7XG4gICAgcmV0dXJuIHMgKyAxO1xuICB9LCAwKSxcbiAgICAgIGZvcmNlUmVuZGVyID0gX3VzZVJlZHVjZXJbMV07XG5cbiAgdmFyIHN1YnNjcmlwdGlvbiA9ICgwLCBfcmVhY3QudXNlTWVtbykoZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBuZXcgX1N1YnNjcmlwdGlvbltcImRlZmF1bHRcIl0oc3RvcmUsIGNvbnRleHRTdWIpO1xuICB9LCBbc3RvcmUsIGNvbnRleHRTdWJdKTtcbiAgdmFyIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IgPSAoMCwgX3JlYWN0LnVzZVJlZikoKTtcbiAgdmFyIGxhdGVzdFNlbGVjdG9yID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBsYXRlc3RTdG9yZVN0YXRlID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBsYXRlc3RTZWxlY3RlZFN0YXRlID0gKDAsIF9yZWFjdC51c2VSZWYpKCk7XG4gIHZhciBzdG9yZVN0YXRlID0gc3RvcmUuZ2V0U3RhdGUoKTtcbiAgdmFyIHNlbGVjdGVkU3RhdGU7XG5cbiAgdHJ5IHtcbiAgICBpZiAoc2VsZWN0b3IgIT09IGxhdGVzdFNlbGVjdG9yLmN1cnJlbnQgfHwgc3RvcmVTdGF0ZSAhPT0gbGF0ZXN0U3RvcmVTdGF0ZS5jdXJyZW50IHx8IGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudCkge1xuICAgICAgdmFyIG5ld1NlbGVjdGVkU3RhdGUgPSBzZWxlY3RvcihzdG9yZVN0YXRlKTsgLy8gZW5zdXJlIGxhdGVzdCBzZWxlY3RlZCBzdGF0ZSBpcyByZXVzZWQgc28gdGhhdCBhIGN1c3RvbSBlcXVhbGl0eSBmdW5jdGlvbiBjYW4gcmVzdWx0IGluIGlkZW50aWNhbCByZWZlcmVuY2VzXG5cbiAgICAgIGlmIChsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPT09IHVuZGVmaW5lZCB8fCAhZXF1YWxpdHlGbihuZXdTZWxlY3RlZFN0YXRlLCBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQpKSB7XG4gICAgICAgIHNlbGVjdGVkU3RhdGUgPSBuZXdTZWxlY3RlZFN0YXRlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2VsZWN0ZWRTdGF0ZSA9IGxhdGVzdFNlbGVjdGVkU3RhdGUuY3VycmVudDtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgc2VsZWN0ZWRTdGF0ZSA9IGxhdGVzdFNlbGVjdGVkU3RhdGUuY3VycmVudDtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChsYXRlc3RTdWJzY3JpcHRpb25DYWxsYmFja0Vycm9yLmN1cnJlbnQpIHtcbiAgICAgIGVyci5tZXNzYWdlICs9IFwiXFxuVGhlIGVycm9yIG1heSBiZSBjb3JyZWxhdGVkIHdpdGggdGhpcyBwcmV2aW91cyBlcnJvcjpcXG5cIiArIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudC5zdGFjayArIFwiXFxuXFxuXCI7XG4gICAgfVxuXG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgKDAsIF91c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0LnVzZUlzb21vcnBoaWNMYXlvdXRFZmZlY3QpKGZ1bmN0aW9uICgpIHtcbiAgICBsYXRlc3RTZWxlY3Rvci5jdXJyZW50ID0gc2VsZWN0b3I7XG4gICAgbGF0ZXN0U3RvcmVTdGF0ZS5jdXJyZW50ID0gc3RvcmVTdGF0ZTtcbiAgICBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPSBzZWxlY3RlZFN0YXRlO1xuICAgIGxhdGVzdFN1YnNjcmlwdGlvbkNhbGxiYWNrRXJyb3IuY3VycmVudCA9IHVuZGVmaW5lZDtcbiAgfSk7XG4gICgwLCBfdXNlSXNvbW9ycGhpY0xheW91dEVmZmVjdC51c2VJc29tb3JwaGljTGF5b3V0RWZmZWN0KShmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gY2hlY2tGb3JVcGRhdGVzKCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdmFyIG5ld1N0b3JlU3RhdGUgPSBzdG9yZS5nZXRTdGF0ZSgpO1xuXG4gICAgICAgIHZhciBfbmV3U2VsZWN0ZWRTdGF0ZSA9IGxhdGVzdFNlbGVjdG9yLmN1cnJlbnQobmV3U3RvcmVTdGF0ZSk7XG5cbiAgICAgICAgaWYgKGVxdWFsaXR5Rm4oX25ld1NlbGVjdGVkU3RhdGUsIGxhdGVzdFNlbGVjdGVkU3RhdGUuY3VycmVudCkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsYXRlc3RTZWxlY3RlZFN0YXRlLmN1cnJlbnQgPSBfbmV3U2VsZWN0ZWRTdGF0ZTtcbiAgICAgICAgbGF0ZXN0U3RvcmVTdGF0ZS5jdXJyZW50ID0gbmV3U3RvcmVTdGF0ZTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyB3ZSBpZ25vcmUgYWxsIGVycm9ycyBoZXJlLCBzaW5jZSB3aGVuIHRoZSBjb21wb25lbnRcbiAgICAgICAgLy8gaXMgcmUtcmVuZGVyZWQsIHRoZSBzZWxlY3RvcnMgYXJlIGNhbGxlZCBhZ2FpbiwgYW5kXG4gICAgICAgIC8vIHdpbGwgdGhyb3cgYWdhaW4sIGlmIG5laXRoZXIgcHJvcHMgbm9yIHN0b3JlIHN0YXRlXG4gICAgICAgIC8vIGNoYW5nZWRcbiAgICAgICAgbGF0ZXN0U3Vic2NyaXB0aW9uQ2FsbGJhY2tFcnJvci5jdXJyZW50ID0gZXJyO1xuICAgICAgfVxuXG4gICAgICBmb3JjZVJlbmRlcigpO1xuICAgIH1cblxuICAgIHN1YnNjcmlwdGlvbi5vblN0YXRlQ2hhbmdlID0gY2hlY2tGb3JVcGRhdGVzO1xuICAgIHN1YnNjcmlwdGlvbi50cnlTdWJzY3JpYmUoKTtcbiAgICBjaGVja0ZvclVwZGF0ZXMoKTtcbiAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xuICAgICAgcmV0dXJuIHN1YnNjcmlwdGlvbi50cnlVbnN1YnNjcmliZSgpO1xuICAgIH07XG4gIH0sIFtzdG9yZSwgc3Vic2NyaXB0aW9uXSk7XG4gIHJldHVybiBzZWxlY3RlZFN0YXRlO1xufVxuLyoqXHJcbiAqIEhvb2sgZmFjdG9yeSwgd2hpY2ggY3JlYXRlcyBhIGB1c2VTZWxlY3RvcmAgaG9vayBib3VuZCB0byBhIGdpdmVuIGNvbnRleHQuXHJcbiAqXHJcbiAqIEBwYXJhbSB7UmVhY3QuQ29udGV4dH0gW2NvbnRleHQ9UmVhY3RSZWR1eENvbnRleHRdIENvbnRleHQgcGFzc2VkIHRvIHlvdXIgYDxQcm92aWRlcj5gLlxyXG4gKiBAcmV0dXJucyB7RnVuY3Rpb259IEEgYHVzZVNlbGVjdG9yYCBob29rIGJvdW5kIHRvIHRoZSBzcGVjaWZpZWQgY29udGV4dC5cclxuICovXG5cblxuZnVuY3Rpb24gY3JlYXRlU2VsZWN0b3JIb29rKGNvbnRleHQpIHtcbiAgaWYgKGNvbnRleHQgPT09IHZvaWQgMCkge1xuICAgIGNvbnRleHQgPSBfQ29udGV4dC5SZWFjdFJlZHV4Q29udGV4dDtcbiAgfVxuXG4gIHZhciB1c2VSZWR1eENvbnRleHQgPSBjb250ZXh0ID09PSBfQ29udGV4dC5SZWFjdFJlZHV4Q29udGV4dCA/IF91c2VSZWR1eENvbnRleHQyLnVzZVJlZHV4Q29udGV4dCA6IGZ1bmN0aW9uICgpIHtcbiAgICByZXR1cm4gKDAsIF9yZWFjdC51c2VDb250ZXh0KShjb250ZXh0KTtcbiAgfTtcbiAgcmV0dXJuIGZ1bmN0aW9uIHVzZVNlbGVjdG9yKHNlbGVjdG9yLCBlcXVhbGl0eUZuKSB7XG4gICAgaWYgKGVxdWFsaXR5Rm4gPT09IHZvaWQgMCkge1xuICAgICAgZXF1YWxpdHlGbiA9IHJlZkVxdWFsaXR5O1xuICAgIH1cblxuICAgIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgICBpZiAoIXNlbGVjdG9yKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IHBhc3MgYSBzZWxlY3RvciB0byB1c2VTZWxlY3RvclwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiBzZWxlY3RvciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJZb3UgbXVzdCBwYXNzIGEgZnVuY3Rpb24gYXMgYSBzZWxlY3RvciB0byB1c2VTZWxlY3RvclwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiBlcXVhbGl0eUZuICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIllvdSBtdXN0IHBhc3MgYSBmdW5jdGlvbiBhcyBhbiBlcXVhbGl0eSBmdW5jdGlvbiB0byB1c2VTZWxlY3RvclwiKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB2YXIgX3VzZVJlZHV4Q29udGV4dCA9IHVzZVJlZHV4Q29udGV4dCgpLFxuICAgICAgICBzdG9yZSA9IF91c2VSZWR1eENvbnRleHQuc3RvcmUsXG4gICAgICAgIGNvbnRleHRTdWIgPSBfdXNlUmVkdXhDb250ZXh0LnN1YnNjcmlwdGlvbjtcblxuICAgIHZhciBzZWxlY3RlZFN0YXRlID0gdXNlU2VsZWN0b3JXaXRoU3RvcmVBbmRTdWJzY3JpcHRpb24oc2VsZWN0b3IsIGVxdWFsaXR5Rm4sIHN0b3JlLCBjb250ZXh0U3ViKTtcbiAgICAoMCwgX3JlYWN0LnVzZURlYnVnVmFsdWUpKHNlbGVjdGVkU3RhdGUpO1xuICAgIHJldHVybiBzZWxlY3RlZFN0YXRlO1xuICB9O1xufVxuLyoqXHJcbiAqIEEgaG9vayB0byBhY2Nlc3MgdGhlIHJlZHV4IHN0b3JlJ3Mgc3RhdGUuIFRoaXMgaG9vayB0YWtlcyBhIHNlbGVjdG9yIGZ1bmN0aW9uXHJcbiAqIGFzIGFuIGFyZ3VtZW50LiBUaGUgc2VsZWN0b3IgaXMgY2FsbGVkIHdpdGggdGhlIHN0b3JlIHN0YXRlLlxyXG4gKlxyXG4gKiBUaGlzIGhvb2sgdGFrZXMgYW4gb3B0aW9uYWwgZXF1YWxpdHkgY29tcGFyaXNvbiBmdW5jdGlvbiBhcyB0aGUgc2Vjb25kIHBhcmFtZXRlclxyXG4gKiB0aGF0IGFsbG93cyB5b3UgdG8gY3VzdG9taXplIHRoZSB3YXkgdGhlIHNlbGVjdGVkIHN0YXRlIGlzIGNvbXBhcmVkIHRvIGRldGVybWluZVxyXG4gKiB3aGV0aGVyIHRoZSBjb21wb25lbnQgbmVlZHMgdG8gYmUgcmUtcmVuZGVyZWQuXHJcbiAqXHJcbiAqIEBwYXJhbSB7RnVuY3Rpb259IHNlbGVjdG9yIHRoZSBzZWxlY3RvciBmdW5jdGlvblxyXG4gKiBAcGFyYW0ge0Z1bmN0aW9uPX0gZXF1YWxpdHlGbiB0aGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIHVzZWQgdG8gZGV0ZXJtaW5lIGVxdWFsaXR5XHJcbiAqXHJcbiAqIEByZXR1cm5zIHthbnl9IHRoZSBzZWxlY3RlZCBzdGF0ZVxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKlxyXG4gKiBpbXBvcnQgUmVhY3QgZnJvbSAncmVhY3QnXHJcbiAqIGltcG9ydCB7IHVzZVNlbGVjdG9yIH0gZnJvbSAncmVhY3QtcmVkdXgnXHJcbiAqXHJcbiAqIGV4cG9ydCBjb25zdCBDb3VudGVyQ29tcG9uZW50ID0gKCkgPT4ge1xyXG4gKiAgIGNvbnN0IGNvdW50ZXIgPSB1c2VTZWxlY3RvcihzdGF0ZSA9PiBzdGF0ZS5jb3VudGVyKVxyXG4gKiAgIHJldHVybiA8ZGl2Pntjb3VudGVyfTwvZGl2PlxyXG4gKiB9XHJcbiAqL1xuXG5cbnZhciB1c2VTZWxlY3RvciA9IC8qI19fUFVSRV9fKi9jcmVhdGVTZWxlY3Rvckhvb2soKTtcbmV4cG9ydHMudXNlU2VsZWN0b3IgPSB1c2VTZWxlY3RvcjsiXX0=