18bfcc12a4ed2648e4461c36934bacee
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports.impureFinalPropsSelectorFactory = impureFinalPropsSelectorFactory;
exports.pureFinalPropsSelectorFactory = pureFinalPropsSelectorFactory;
exports["default"] = finalPropsSelectorFactory;

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _verifySubselectors = _interopRequireDefault(require("./verifySubselectors"));

function impureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch) {
  return function impureFinalPropsSelector(state, ownProps) {
    return mergeProps(mapStateToProps(state, ownProps), mapDispatchToProps(dispatch, ownProps), ownProps);
  };
}

function pureFinalPropsSelectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, _ref) {
  var areStatesEqual = _ref.areStatesEqual,
      areOwnPropsEqual = _ref.areOwnPropsEqual,
      areStatePropsEqual = _ref.areStatePropsEqual;
  var hasRunAtLeastOnce = false;
  var state;
  var ownProps;
  var stateProps;
  var dispatchProps;
  var mergedProps;

  function handleFirstCall(firstState, firstOwnProps) {
    state = firstState;
    ownProps = firstOwnProps;
    stateProps = mapStateToProps(state, ownProps);
    dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    hasRunAtLeastOnce = true;
    return mergedProps;
  }

  function handleNewPropsAndNewState() {
    stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewProps() {
    if (mapStateToProps.dependsOnOwnProps) stateProps = mapStateToProps(state, ownProps);
    if (mapDispatchToProps.dependsOnOwnProps) dispatchProps = mapDispatchToProps(dispatch, ownProps);
    mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleNewState() {
    var nextStateProps = mapStateToProps(state, ownProps);
    var statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps);
    stateProps = nextStateProps;
    if (statePropsChanged) mergedProps = mergeProps(stateProps, dispatchProps, ownProps);
    return mergedProps;
  }

  function handleSubsequentCalls(nextState, nextOwnProps) {
    var propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps);
    var stateChanged = !areStatesEqual(nextState, state);
    state = nextState;
    ownProps = nextOwnProps;
    if (propsChanged && stateChanged) return handleNewPropsAndNewState();
    if (propsChanged) return handleNewProps();
    if (stateChanged) return handleNewState();
    return mergedProps;
  }

  return function pureFinalPropsSelector(nextState, nextOwnProps) {
    return hasRunAtLeastOnce ? handleSubsequentCalls(nextState, nextOwnProps) : handleFirstCall(nextState, nextOwnProps);
  };
}

function finalPropsSelectorFactory(dispatch, _ref2) {
  var initMapStateToProps = _ref2.initMapStateToProps,
      initMapDispatchToProps = _ref2.initMapDispatchToProps,
      initMergeProps = _ref2.initMergeProps,
      options = (0, _objectWithoutPropertiesLoose2["default"])(_ref2, ["initMapStateToProps", "initMapDispatchToProps", "initMergeProps"]);
  var mapStateToProps = initMapStateToProps(dispatch, options);
  var mapDispatchToProps = initMapDispatchToProps(dispatch, options);
  var mergeProps = initMergeProps(dispatch, options);

  if (process.env.NODE_ENV !== 'production') {
    (0, _verifySubselectors["default"])(mapStateToProps, mapDispatchToProps, mergeProps, options.displayName);
  }

  var selectorFactory = options.pure ? pureFinalPropsSelectorFactory : impureFinalPropsSelectorFactory;
  return selectorFactory(mapStateToProps, mapDispatchToProps, mergeProps, dispatch, options);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbGVjdG9yRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsInB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5IiwiZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeSIsIl9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiIsIl92ZXJpZnlTdWJzZWxlY3RvcnMiLCJtYXBTdGF0ZVRvUHJvcHMiLCJtYXBEaXNwYXRjaFRvUHJvcHMiLCJtZXJnZVByb3BzIiwiZGlzcGF0Y2giLCJpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3IiLCJzdGF0ZSIsIm93blByb3BzIiwiX3JlZiIsImFyZVN0YXRlc0VxdWFsIiwiYXJlT3duUHJvcHNFcXVhbCIsImFyZVN0YXRlUHJvcHNFcXVhbCIsImhhc1J1bkF0TGVhc3RPbmNlIiwic3RhdGVQcm9wcyIsImRpc3BhdGNoUHJvcHMiLCJtZXJnZWRQcm9wcyIsImhhbmRsZUZpcnN0Q2FsbCIsImZpcnN0U3RhdGUiLCJmaXJzdE93blByb3BzIiwiaGFuZGxlTmV3UHJvcHNBbmROZXdTdGF0ZSIsImRlcGVuZHNPbk93blByb3BzIiwiaGFuZGxlTmV3UHJvcHMiLCJoYW5kbGVOZXdTdGF0ZSIsIm5leHRTdGF0ZVByb3BzIiwic3RhdGVQcm9wc0NoYW5nZWQiLCJoYW5kbGVTdWJzZXF1ZW50Q2FsbHMiLCJuZXh0U3RhdGUiLCJuZXh0T3duUHJvcHMiLCJwcm9wc0NoYW5nZWQiLCJzdGF0ZUNoYW5nZWQiLCJwdXJlRmluYWxQcm9wc1NlbGVjdG9yIiwiX3JlZjIiLCJpbml0TWFwU3RhdGVUb1Byb3BzIiwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyIsImluaXRNZXJnZVByb3BzIiwib3B0aW9ucyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsImRpc3BsYXlOYW1lIiwic2VsZWN0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LEtBQTdDLEVBQW9EO0FBQ2xELE1BQUlDLG1CQUFtQixHQUFHRCxLQUFLLENBQUNDLG1CQUFoQztBQUFBLE1BQ0lDLHNCQUFzQixHQUFHRixLQUFLLENBQUNFLHNCQURuQztBQUFBLE1BRUlDLGNBQWMsR0FBR0gsS0FBSyxDQUFDRyxjQUYzQjtBQUFBLE1BR0lDLE9BQU8sR0FBRyxDQUFDLEdBQUdwQyw4QkFBOEIsQ0FBQyxTQUFELENBQWxDLEVBQStDZ0MsS0FBL0MsRUFBc0QsQ0FBQyxxQkFBRCxFQUF3Qix3QkFBeEIsRUFBa0QsZ0JBQWxELENBQXRELENBSGQ7QUFJQSxNQUFJOUIsZUFBZSxHQUFHK0IsbUJBQW1CLENBQUM1QixRQUFELEVBQVcrQixPQUFYLENBQXpDO0FBQ0EsTUFBSWpDLGtCQUFrQixHQUFHK0Isc0JBQXNCLENBQUM3QixRQUFELEVBQVcrQixPQUFYLENBQS9DO0FBQ0EsTUFBSWhDLFVBQVUsR0FBRytCLGNBQWMsQ0FBQzlCLFFBQUQsRUFBVytCLE9BQVgsQ0FBL0I7O0FBRUEsTUFBSUMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFFBQVosS0FBeUIsWUFBN0IsRUFBMkM7QUFDekMsS0FBQyxHQUFHdEMsbUJBQW1CLENBQUMsU0FBRCxDQUF2QixFQUFvQ0MsZUFBcEMsRUFBcURDLGtCQUFyRCxFQUF5RUMsVUFBekUsRUFBcUZnQyxPQUFPLENBQUNJLFdBQTdGO0FBQ0Q7O0FBRUQsTUFBSUMsZUFBZSxHQUFHTCxPQUFPLENBQUNNLElBQVIsR0FBZTVDLDZCQUFmLEdBQStDRCwrQkFBckU7QUFDQSxTQUFPNEMsZUFBZSxDQUFDdkMsZUFBRCxFQUFrQkMsa0JBQWxCLEVBQXNDQyxVQUF0QyxFQUFrREMsUUFBbEQsRUFBNEQrQixPQUE1RCxDQUF0QjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbnZhciBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0ID0gcmVxdWlyZShcIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvaW50ZXJvcFJlcXVpcmVEZWZhdWx0XCIpO1xuXG5leHBvcnRzLl9fZXNNb2R1bGUgPSB0cnVlO1xuZXhwb3J0cy5pbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5ID0gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcbmV4cG9ydHMucHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkgPSBwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcbmV4cG9ydHNbXCJkZWZhdWx0XCJdID0gZmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeTtcblxudmFyIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMiA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIkBiYWJlbC9ydW50aW1lL2hlbHBlcnMvb2JqZWN0V2l0aG91dFByb3BlcnRpZXNMb29zZVwiKSk7XG5cbnZhciBfdmVyaWZ5U3Vic2VsZWN0b3JzID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi92ZXJpZnlTdWJzZWxlY3RvcnNcIikpO1xuXG5mdW5jdGlvbiBpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5KG1hcFN0YXRlVG9Qcm9wcywgbWFwRGlzcGF0Y2hUb1Byb3BzLCBtZXJnZVByb3BzLCBkaXNwYXRjaCkge1xuICByZXR1cm4gZnVuY3Rpb24gaW1wdXJlRmluYWxQcm9wc1NlbGVjdG9yKHN0YXRlLCBvd25Qcm9wcykge1xuICAgIHJldHVybiBtZXJnZVByb3BzKG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpLCBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKSwgb3duUHJvcHMpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBwdXJlRmluYWxQcm9wc1NlbGVjdG9yRmFjdG9yeShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgZGlzcGF0Y2gsIF9yZWYpIHtcbiAgdmFyIGFyZVN0YXRlc0VxdWFsID0gX3JlZi5hcmVTdGF0ZXNFcXVhbCxcbiAgICAgIGFyZU93blByb3BzRXF1YWwgPSBfcmVmLmFyZU93blByb3BzRXF1YWwsXG4gICAgICBhcmVTdGF0ZVByb3BzRXF1YWwgPSBfcmVmLmFyZVN0YXRlUHJvcHNFcXVhbDtcbiAgdmFyIGhhc1J1bkF0TGVhc3RPbmNlID0gZmFsc2U7XG4gIHZhciBzdGF0ZTtcbiAgdmFyIG93blByb3BzO1xuICB2YXIgc3RhdGVQcm9wcztcbiAgdmFyIGRpc3BhdGNoUHJvcHM7XG4gIHZhciBtZXJnZWRQcm9wcztcblxuICBmdW5jdGlvbiBoYW5kbGVGaXJzdENhbGwoZmlyc3RTdGF0ZSwgZmlyc3RPd25Qcm9wcykge1xuICAgIHN0YXRlID0gZmlyc3RTdGF0ZTtcbiAgICBvd25Qcm9wcyA9IGZpcnN0T3duUHJvcHM7XG4gICAgc3RhdGVQcm9wcyA9IG1hcFN0YXRlVG9Qcm9wcyhzdGF0ZSwgb3duUHJvcHMpO1xuICAgIGRpc3BhdGNoUHJvcHMgPSBtYXBEaXNwYXRjaFRvUHJvcHMoZGlzcGF0Y2gsIG93blByb3BzKTtcbiAgICBtZXJnZWRQcm9wcyA9IG1lcmdlUHJvcHMoc3RhdGVQcm9wcywgZGlzcGF0Y2hQcm9wcywgb3duUHJvcHMpO1xuICAgIGhhc1J1bkF0TGVhc3RPbmNlID0gdHJ1ZTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVOZXdQcm9wc0FuZE5ld1N0YXRlKCkge1xuICAgIHN0YXRlUHJvcHMgPSBtYXBTdGF0ZVRvUHJvcHMoc3RhdGUsIG93blByb3BzKTtcbiAgICBpZiAobWFwRGlzcGF0Y2hUb1Byb3BzLmRlcGVuZHNPbk93blByb3BzKSBkaXNwYXRjaFByb3BzID0gbWFwRGlzcGF0Y2hUb1Byb3BzKGRpc3BhdGNoLCBvd25Qcm9wcyk7XG4gICAgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVOZXdQcm9wcygpIHtcbiAgICBpZiAobWFwU3RhdGVUb1Byb3BzLmRlcGVuZHNPbk93blByb3BzKSBzdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgaWYgKG1hcERpc3BhdGNoVG9Qcm9wcy5kZXBlbmRzT25Pd25Qcm9wcykgZGlzcGF0Y2hQcm9wcyA9IG1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3duUHJvcHMpO1xuICAgIG1lcmdlZFByb3BzID0gbWVyZ2VQcm9wcyhzdGF0ZVByb3BzLCBkaXNwYXRjaFByb3BzLCBvd25Qcm9wcyk7XG4gICAgcmV0dXJuIG1lcmdlZFByb3BzO1xuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlTmV3U3RhdGUoKSB7XG4gICAgdmFyIG5leHRTdGF0ZVByb3BzID0gbWFwU3RhdGVUb1Byb3BzKHN0YXRlLCBvd25Qcm9wcyk7XG4gICAgdmFyIHN0YXRlUHJvcHNDaGFuZ2VkID0gIWFyZVN0YXRlUHJvcHNFcXVhbChuZXh0U3RhdGVQcm9wcywgc3RhdGVQcm9wcyk7XG4gICAgc3RhdGVQcm9wcyA9IG5leHRTdGF0ZVByb3BzO1xuICAgIGlmIChzdGF0ZVByb3BzQ2hhbmdlZCkgbWVyZ2VkUHJvcHMgPSBtZXJnZVByb3BzKHN0YXRlUHJvcHMsIGRpc3BhdGNoUHJvcHMsIG93blByb3BzKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVTdWJzZXF1ZW50Q2FsbHMobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpIHtcbiAgICB2YXIgcHJvcHNDaGFuZ2VkID0gIWFyZU93blByb3BzRXF1YWwobmV4dE93blByb3BzLCBvd25Qcm9wcyk7XG4gICAgdmFyIHN0YXRlQ2hhbmdlZCA9ICFhcmVTdGF0ZXNFcXVhbChuZXh0U3RhdGUsIHN0YXRlKTtcbiAgICBzdGF0ZSA9IG5leHRTdGF0ZTtcbiAgICBvd25Qcm9wcyA9IG5leHRPd25Qcm9wcztcbiAgICBpZiAocHJvcHNDaGFuZ2VkICYmIHN0YXRlQ2hhbmdlZCkgcmV0dXJuIGhhbmRsZU5ld1Byb3BzQW5kTmV3U3RhdGUoKTtcbiAgICBpZiAocHJvcHNDaGFuZ2VkKSByZXR1cm4gaGFuZGxlTmV3UHJvcHMoKTtcbiAgICBpZiAoc3RhdGVDaGFuZ2VkKSByZXR1cm4gaGFuZGxlTmV3U3RhdGUoKTtcbiAgICByZXR1cm4gbWVyZ2VkUHJvcHM7XG4gIH1cblxuICByZXR1cm4gZnVuY3Rpb24gcHVyZUZpbmFsUHJvcHNTZWxlY3RvcihuZXh0U3RhdGUsIG5leHRPd25Qcm9wcykge1xuICAgIHJldHVybiBoYXNSdW5BdExlYXN0T25jZSA/IGhhbmRsZVN1YnNlcXVlbnRDYWxscyhuZXh0U3RhdGUsIG5leHRPd25Qcm9wcykgOiBoYW5kbGVGaXJzdENhbGwobmV4dFN0YXRlLCBuZXh0T3duUHJvcHMpO1xuICB9O1xufSAvLyBUT0RPOiBBZGQgbW9yZSBjb21tZW50c1xuLy8gSWYgcHVyZSBpcyB0cnVlLCB0aGUgc2VsZWN0b3IgcmV0dXJuZWQgYnkgc2VsZWN0b3JGYWN0b3J5IHdpbGwgbWVtb2l6ZSBpdHMgcmVzdWx0cyxcbi8vIGFsbG93aW5nIGNvbm5lY3RBZHZhbmNlZCdzIHNob3VsZENvbXBvbmVudFVwZGF0ZSB0byByZXR1cm4gZmFsc2UgaWYgZmluYWxcbi8vIHByb3BzIGhhdmUgbm90IGNoYW5nZWQuIElmIGZhbHNlLCB0aGUgc2VsZWN0b3Igd2lsbCBhbHdheXMgcmV0dXJuIGEgbmV3XG4vLyBvYmplY3QgYW5kIHNob3VsZENvbXBvbmVudFVwZGF0ZSB3aWxsIGFsd2F5cyByZXR1cm4gdHJ1ZS5cblxuXG5mdW5jdGlvbiBmaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5KGRpc3BhdGNoLCBfcmVmMikge1xuICB2YXIgaW5pdE1hcFN0YXRlVG9Qcm9wcyA9IF9yZWYyLmluaXRNYXBTdGF0ZVRvUHJvcHMsXG4gICAgICBpbml0TWFwRGlzcGF0Y2hUb1Byb3BzID0gX3JlZjIuaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyxcbiAgICAgIGluaXRNZXJnZVByb3BzID0gX3JlZjIuaW5pdE1lcmdlUHJvcHMsXG4gICAgICBvcHRpb25zID0gKDAsIF9vYmplY3RXaXRob3V0UHJvcGVydGllc0xvb3NlMltcImRlZmF1bHRcIl0pKF9yZWYyLCBbXCJpbml0TWFwU3RhdGVUb1Byb3BzXCIsIFwiaW5pdE1hcERpc3BhdGNoVG9Qcm9wc1wiLCBcImluaXRNZXJnZVByb3BzXCJdKTtcbiAgdmFyIG1hcFN0YXRlVG9Qcm9wcyA9IGluaXRNYXBTdGF0ZVRvUHJvcHMoZGlzcGF0Y2gsIG9wdGlvbnMpO1xuICB2YXIgbWFwRGlzcGF0Y2hUb1Byb3BzID0gaW5pdE1hcERpc3BhdGNoVG9Qcm9wcyhkaXNwYXRjaCwgb3B0aW9ucyk7XG4gIHZhciBtZXJnZVByb3BzID0gaW5pdE1lcmdlUHJvcHMoZGlzcGF0Y2gsIG9wdGlvbnMpO1xuXG4gIGlmIChwcm9jZXNzLmVudi5OT0RFX0VOViAhPT0gJ3Byb2R1Y3Rpb24nKSB7XG4gICAgKDAsIF92ZXJpZnlTdWJzZWxlY3RvcnNbXCJkZWZhdWx0XCJdKShtYXBTdGF0ZVRvUHJvcHMsIG1hcERpc3BhdGNoVG9Qcm9wcywgbWVyZ2VQcm9wcywgb3B0aW9ucy5kaXNwbGF5TmFtZSk7XG4gIH1cblxuICB2YXIgc2VsZWN0b3JGYWN0b3J5ID0gb3B0aW9ucy5wdXJlID8gcHVyZUZpbmFsUHJvcHNTZWxlY3RvckZhY3RvcnkgOiBpbXB1cmVGaW5hbFByb3BzU2VsZWN0b3JGYWN0b3J5O1xuICByZXR1cm4gc2VsZWN0b3JGYWN0b3J5KG1hcFN0YXRlVG9Qcm9wcywgbWFwRGlzcGF0Y2hUb1Byb3BzLCBtZXJnZVByb3BzLCBkaXNwYXRjaCwgb3B0aW9ucyk7XG59Il19