8c323961321124bb86072ac7310c071e
"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _batch = require("./batch");

var nullListeners = {
  notify: function notify() {}
};

function createListenerCollection() {
  var batch = (0, _batch.getBatch)();
  var first = null;
  var last = null;
  return {
    clear: function clear() {
      first = null;
      last = null;
    },
    notify: function notify() {
      batch(function () {
        var listener = first;

        while (listener) {
          listener.callback();
          listener = listener.next;
        }
      });
    },
    get: function get() {
      var listeners = [];
      var listener = first;

      while (listener) {
        listeners.push(listener);
        listener = listener.next;
      }

      return listeners;
    },
    subscribe: function subscribe(callback) {
      var isSubscribed = true;
      var listener = last = {
        callback: callback,
        next: null,
        prev: last
      };

      if (listener.prev) {
        listener.prev.next = listener;
      } else {
        first = listener;
      }

      return function unsubscribe() {
        if (!isSubscribed || first === null) return;
        isSubscribed = false;

        if (listener.next) {
          listener.next.prev = listener.prev;
        } else {
          last = listener.prev;
        }

        if (listener.prev) {
          listener.prev.next = listener.next;
        } else {
          first = listener.next;
        }
      };
    }
  };
}

var Subscription = function () {
  function Subscription(store, parentSub) {
    this.store = store;
    this.parentSub = parentSub;
    this.unsubscribe = null;
    this.listeners = nullListeners;
    this.handleChangeWrapper = this.handleChangeWrapper.bind(this);
  }

  var _proto = Subscription.prototype;

  _proto.addNestedSub = function addNestedSub(listener) {
    this.trySubscribe();
    return this.listeners.subscribe(listener);
  };

  _proto.notifyNestedSubs = function notifyNestedSubs() {
    this.listeners.notify();
  };

  _proto.handleChangeWrapper = function handleChangeWrapper() {
    if (this.onStateChange) {
      this.onStateChange();
    }
  };

  _proto.isSubscribed = function isSubscribed() {
    return Boolean(this.unsubscribe);
  };

  _proto.trySubscribe = function trySubscribe() {
    if (!this.unsubscribe) {
      this.unsubscribe = this.parentSub ? this.parentSub.addNestedSub(this.handleChangeWrapper) : this.store.subscribe(this.handleChangeWrapper);
      this.listeners = createListenerCollection();
    }
  };

  _proto.tryUnsubscribe = function tryUnsubscribe() {
    if (this.unsubscribe) {
      this.unsubscribe();
      this.unsubscribe = null;
      this.listeners.clear();
      this.listeners = nullListeners;
    }
  };

  return Subscription;
}();

exports["default"] = Subscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN1YnNjcmlwdGlvbi5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsIl9iYXRjaCIsInJlcXVpcmUiLCJudWxsTGlzdGVuZXJzIiwibm90aWZ5IiwiY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uIiwiYmF0Y2giLCJnZXRCYXRjaCIsImZpcnN0IiwibGFzdCIsImNsZWFyIiwibGlzdGVuZXIiLCJjYWxsYmFjayIsIm5leHQiLCJnZXQiLCJsaXN0ZW5lcnMiLCJwdXNoIiwic3Vic2NyaWJlIiwiaXNTdWJzY3JpYmVkIiwicHJldiIsInVuc3Vic2NyaWJlIiwiU3Vic2NyaXB0aW9uIiwic3RvcmUiLCJwYXJlbnRTdWIiLCJoYW5kbGVDaGFuZ2VXcmFwcGVyIiwiYmluZCIsIl9wcm90byIsInByb3RvdHlwZSIsImFkZE5lc3RlZFN1YiIsInRyeVN1YnNjcmliZSIsIm5vdGlmeU5lc3RlZFN1YnMiLCJvblN0YXRlQ2hhbmdlIiwiQm9vbGVhbiIsInRyeVVuc3Vic2NyaWJlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsT0FBTyxDQUFDQyxVQUFSLEdBQXFCLElBQXJCO0FBQ0FELE9BQU8sQ0FBQyxTQUFELENBQVAsR0FBcUIsS0FBSyxDQUExQjs7QUFFQSxJQUFJRSxNQUFNLEdBQUdDLE9BQU8sV0FBcEI7O0FBS0EsSUFBSUMsYUFBYSxHQUFHO0FBQ2xCQyxFQUFBQSxNQUFNLEVBQUUsU0FBU0EsTUFBVCxHQUFrQixDQUFFO0FBRFYsQ0FBcEI7O0FBSUEsU0FBU0Msd0JBQVQsR0FBb0M7QUFDbEMsTUFBSUMsS0FBSyxHQUFHLENBQUMsR0FBR0wsTUFBTSxDQUFDTSxRQUFYLEdBQVo7QUFDQSxNQUFJQyxLQUFLLEdBQUcsSUFBWjtBQUNBLE1BQUlDLElBQUksR0FBRyxJQUFYO0FBQ0EsU0FBTztBQUNMQyxJQUFBQSxLQUFLLEVBQUUsU0FBU0EsS0FBVCxHQUFpQjtBQUN0QkYsTUFBQUEsS0FBSyxHQUFHLElBQVI7QUFDQUMsTUFBQUEsSUFBSSxH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QUlBc0IsRUFBQUEsTUFBTSxDQUFDRixtQkFBUCxHQUE2QixTQUFTQSxtQkFBVCxHQUErQjtBQUMxRCxRQUFJLEtBQUtPLGFBQVQsRUFBd0I7QUFDdEIsV0FBS0EsYUFBTDtBQUNEO0FBQ0YsR0FKRDs7QUFNQUwsRUFBQUEsTUFBTSxDQUFDUixZQUFQLEdBQXNCLFNBQVNBLFlBQVQsR0FBd0I7QUFDNUMsV0FBT2MsT0FBTyxDQUFDLEtBQUtaLFdBQU4sQ0FBZDtBQUNELEdBRkQ7O0FBSUFNLEVBQUFBLE1BQU0sQ0FBQ0csWUFBUCxHQUFzQixTQUFTQSxZQUFULEdBQXdCO0FBQzVDLFFBQUksQ0FBQyxLQUFLVCxXQUFWLEVBQXVCO0FBQ3JCLFdBQUtBLFdBQUwsR0FBbUIsS0FBS0csU0FBTCxHQUFpQixLQUFLQSxTQUFMLENBQWVLLFlBQWYsQ0FBNEIsS0FBS0osbUJBQWpDLENBQWpCLEdBQXlFLEtBQUtGLEtBQUwsQ0FBV0wsU0FBWCxDQUFxQixLQUFLTyxtQkFBMUIsQ0FBNUY7QUFDQSxXQUFLVCxTQUFMLEdBQWlCVix3QkFBd0IsRUFBekM7QUFDRDtBQUNGLEdBTEQ7O0FBT0FxQixFQUFBQSxNQUFNLENBQUNPLGNBQVAsR0FBd0IsU0FBU0EsY0FBVCxHQUEwQjtBQUNoRCxRQUFJLEtBQUtiLFdBQVQsRUFBc0I7QUFDcEIsV0FBS0EsV0FBTDtBQUNBLFdBQUtBLFdBQUwsR0FBbUIsSUFBbkI7QUFDQSxXQUFLTCxTQUFMLENBQWVMLEtBQWY7QUFDQSxXQUFLSyxTQUFMLEdBQWlCWixhQUFqQjtBQUNEO0FBQ0YsR0FQRDs7QUFTQSxTQUFPa0IsWUFBUDtBQUNELENBL0MrQixFQUFoQzs7QUFpREF0QixPQUFPLENBQUMsU0FBRCxDQUFQLEdBQXFCc0IsWUFBckIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHNbXCJkZWZhdWx0XCJdID0gdm9pZCAwO1xuXG52YXIgX2JhdGNoID0gcmVxdWlyZShcIi4vYmF0Y2hcIik7XG5cbi8vIGVuY2Fwc3VsYXRlcyB0aGUgc3Vic2NyaXB0aW9uIGxvZ2ljIGZvciBjb25uZWN0aW5nIGEgY29tcG9uZW50IHRvIHRoZSByZWR1eCBzdG9yZSwgYXNcbi8vIHdlbGwgYXMgbmVzdGluZyBzdWJzY3JpcHRpb25zIG9mIGRlc2NlbmRhbnQgY29tcG9uZW50cywgc28gdGhhdCB3ZSBjYW4gZW5zdXJlIHRoZVxuLy8gYW5jZXN0b3IgY29tcG9uZW50cyByZS1yZW5kZXIgYmVmb3JlIGRlc2NlbmRhbnRzXG52YXIgbnVsbExpc3RlbmVycyA9IHtcbiAgbm90aWZ5OiBmdW5jdGlvbiBub3RpZnkoKSB7fVxufTtcblxuZnVuY3Rpb24gY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uKCkge1xuICB2YXIgYmF0Y2ggPSAoMCwgX2JhdGNoLmdldEJhdGNoKSgpO1xuICB2YXIgZmlyc3QgPSBudWxsO1xuICB2YXIgbGFzdCA9IG51bGw7XG4gIHJldHVybiB7XG4gICAgY2xlYXI6IGZ1bmN0aW9uIGNsZWFyKCkge1xuICAgICAgZmlyc3QgPSBudWxsO1xuICAgICAgbGFzdCA9IG51bGw7XG4gICAgfSxcbiAgICBub3RpZnk6IGZ1bmN0aW9uIG5vdGlmeSgpIHtcbiAgICAgIGJhdGNoKGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIGxpc3RlbmVyID0gZmlyc3Q7XG5cbiAgICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgICAgbGlzdGVuZXIuY2FsbGJhY2soKTtcbiAgICAgICAgICBsaXN0ZW5lciA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG4gICAgZ2V0OiBmdW5jdGlvbiBnZXQoKSB7XG4gICAgICB2YXIgbGlzdGVuZXJzID0gW107XG4gICAgICB2YXIgbGlzdGVuZXIgPSBmaXJzdDtcblxuICAgICAgd2hpbGUgKGxpc3RlbmVyKSB7XG4gICAgICAgIGxpc3RlbmVycy5wdXNoKGxpc3RlbmVyKTtcbiAgICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbGlzdGVuZXJzO1xuICAgIH0sXG4gICAgc3Vic2NyaWJlOiBmdW5jdGlvbiBzdWJzY3JpYmUoY2FsbGJhY2spIHtcbiAgICAgIHZhciBpc1N1YnNjcmliZWQgPSB0cnVlO1xuICAgICAgdmFyIGxpc3RlbmVyID0gbGFzdCA9IHtcbiAgICAgICAgY2FsbGJhY2s6IGNhbGxiYWNrLFxuICAgICAgICBuZXh0OiBudWxsLFxuICAgICAgICBwcmV2OiBsYXN0XG4gICAgICB9O1xuXG4gICAgICBpZiAobGlzdGVuZXIucHJldikge1xuICAgICAgICBsaXN0ZW5lci5wcmV2Lm5leHQgPSBsaXN0ZW5lcjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGZpcnN0ID0gbGlzdGVuZXI7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmdW5jdGlvbiB1bnN1YnNjcmliZSgpIHtcbiAgICAgICAgaWYgKCFpc1N1YnNjcmliZWQgfHwgZmlyc3QgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgaXNTdWJzY3JpYmVkID0gZmFsc2U7XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyLm5leHQpIHtcbiAgICAgICAgICBsaXN0ZW5lci5uZXh0LnByZXYgPSBsaXN0ZW5lci5wcmV2O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxhc3QgPSBsaXN0ZW5lci5wcmV2O1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyLnByZXYpIHtcbiAgICAgICAgICBsaXN0ZW5lci5wcmV2Lm5leHQgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpcnN0ID0gbGlzdGVuZXIubmV4dDtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG4gIH07XG59XG5cbnZhciBTdWJzY3JpcHRpb24gPSAvKiNfX1BVUkVfXyovZnVuY3Rpb24gKCkge1xuICBmdW5jdGlvbiBTdWJzY3JpcHRpb24oc3RvcmUsIHBhcmVudFN1Yikge1xuICAgIHRoaXMuc3RvcmUgPSBzdG9yZTtcbiAgICB0aGlzLnBhcmVudFN1YiA9IHBhcmVudFN1YjtcbiAgICB0aGlzLnVuc3Vic2NyaWJlID0gbnVsbDtcbiAgICB0aGlzLmxpc3RlbmVycyA9IG51bGxMaXN0ZW5lcnM7XG4gICAgdGhpcy5oYW5kbGVDaGFuZ2VXcmFwcGVyID0gdGhpcy5oYW5kbGVDaGFuZ2VXcmFwcGVyLmJpbmQodGhpcyk7XG4gIH1cblxuICB2YXIgX3Byb3RvID0gU3Vic2NyaXB0aW9uLnByb3RvdHlwZTtcblxuICBfcHJvdG8uYWRkTmVzdGVkU3ViID0gZnVuY3Rpb24gYWRkTmVzdGVkU3ViKGxpc3RlbmVyKSB7XG4gICAgdGhpcy50cnlTdWJzY3JpYmUoKTtcbiAgICByZXR1cm4gdGhpcy5saXN0ZW5lcnMuc3Vic2NyaWJlKGxpc3RlbmVyKTtcbiAgfTtcblxuICBfcHJvdG8ubm90aWZ5TmVzdGVkU3VicyA9IGZ1bmN0aW9uIG5vdGlmeU5lc3RlZFN1YnMoKSB7XG4gICAgdGhpcy5saXN0ZW5lcnMubm90aWZ5KCk7XG4gIH07XG5cbiAgX3Byb3RvLmhhbmRsZUNoYW5nZVdyYXBwZXIgPSBmdW5jdGlvbiBoYW5kbGVDaGFuZ2VXcmFwcGVyKCkge1xuICAgIGlmICh0aGlzLm9uU3RhdGVDaGFuZ2UpIHtcbiAgICAgIHRoaXMub25TdGF0ZUNoYW5nZSgpO1xuICAgIH1cbiAgfTtcblxuICBfcHJvdG8uaXNTdWJzY3JpYmVkID0gZnVuY3Rpb24gaXNTdWJzY3JpYmVkKCkge1xuICAgIHJldHVybiBCb29sZWFuKHRoaXMudW5zdWJzY3JpYmUpO1xuICB9O1xuXG4gIF9wcm90by50cnlTdWJzY3JpYmUgPSBmdW5jdGlvbiB0cnlTdWJzY3JpYmUoKSB7XG4gICAgaWYgKCF0aGlzLnVuc3Vic2NyaWJlKSB7XG4gICAgICB0aGlzLnVuc3Vic2NyaWJlID0gdGhpcy5wYXJlbnRTdWIgPyB0aGlzLnBhcmVudFN1Yi5hZGROZXN0ZWRTdWIodGhpcy5oYW5kbGVDaGFuZ2VXcmFwcGVyKSA6IHRoaXMuc3RvcmUuc3Vic2NyaWJlKHRoaXMuaGFuZGxlQ2hhbmdlV3JhcHBlcik7XG4gICAgICB0aGlzLmxpc3RlbmVycyA9IGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpO1xuICAgIH1cbiAgfTtcblxuICBfcHJvdG8udHJ5VW5zdWJzY3JpYmUgPSBmdW5jdGlvbiB0cnlVbnN1YnNjcmliZSgpIHtcbiAgICBpZiAodGhpcy51bnN1YnNjcmliZSkge1xuICAgICAgdGhpcy51bnN1YnNjcmliZSgpO1xuICAgICAgdGhpcy51bnN1YnNjcmliZSA9IG51bGw7XG4gICAgICB0aGlzLmxpc3RlbmVycy5jbGVhcigpO1xuICAgICAgdGhpcy5saXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzO1xuICAgIH1cbiAgfTtcblxuICByZXR1cm4gU3Vic2NyaXB0aW9uO1xufSgpO1xuXG5leHBvcnRzW1wiZGVmYXVsdFwiXSA9IFN1YnNjcmlwdGlvbjsiXX0=